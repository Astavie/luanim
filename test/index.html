<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Luanim</title>
</head>
<body>
    <p id="stdout"></p>
    <center><canvas id="canvas" width="1280" height="720" style="border:1px solid #000000;"></canvas>
    <br>
    <input id="button" type="button" value="play"></input></center>
    <br>
    <textarea id="script" style="width: 100%; height: 100vh;"></textarea>
    <script type="module">
        import luanim from "./luanim.js"

        const stdout = document.getElementById("stdout")
        const canvas = document.getElementById("canvas")
        const script = document.getElementById("script")
        const button = document.getElementById("button")
        const ctx = canvas.getContext("2d")

        button.addEventListener('click', run)

        async function run() {
            stdout.innerText = "";

            const start = Date.now()
            const print = text => {
                const now = Date.now()
                const diff = (now - start) / 1000
                stdout.innerText += `[${diff}] ${text}\n`
            }

            const instance = await luanim({ 
                print,
                frame_start() {
                    ctx.save()
                    ctx.resetTransform()
                    ctx.clearRect(0, 0, canvas.width, canvas.height)
                    ctx.restore()
                },
                draw_ellipse(x, y, rx, ry, rot) {
                    ctx.beginPath()
                    ctx.ellipse(x, y, rx, ry, rot, 0, 2 * Math.PI)
                    ctx.fill()
                },
                draw_bezier(x1, y1, cx1, cy1, cx2, cy2, x2, y2) {
                    ctx.beginPath()
                    ctx.moveTo(x1, y1)
                    ctx.bezierCurveTo(cx1, cy1, cx2, cy2, x2, y2)
                    ctx.stroke()
                },
                draw_config(lineWidth) {
                    ctx.lineWidth = lineWidth
                },
                set_matrix(a, b, c, d, e, f) {
                    ctx.resetTransform()
                    ctx.translate(canvas.width / 2, canvas.height / 2)
                    ctx.scale(canvas.width / 2, canvas.width / 2)
                    ctx.transform(a, b, c, d, e, f)
                },
                draw_text(x, y, size, text) {
                    ctx.save()
                    ctx.translate(x, y)
                    ctx.scale(0.005 * size, 0.005 * size)
                    ctx.fillText(text, 0, 0)
                    ctx.restore()
                },
            })

            if (!instance) {
                print("could not start luanim")
                return
            }

            const ret = instance.load(script.value)
            if (!ret) {
                print(instance.peekstring())
            } else {
                await new Promise(resolve => {
                    const interval = setInterval(function() {
                        const resume = instance.advance()
                        if (!resume) {
                            clearInterval(interval)
                            resolve()
                        }
                    }, 16);
                })
            }

            instance.close()
        }
    </script>
</body>
</html>
